{
  "name": "Frepi MVP2 - Full Architecture (WhatsApp Enabled)",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "messages"
        ],
        "options": {}
      },
      "type": "n8n-nodes-base.whatsAppTrigger",
      "typeVersion": 1,
      "position": [
        -2560,
        1200
      ],
      "id": "whatsapp-trigger-001",
      "name": "WhatsApp Trigger",
      "webhookId": "frepi-v2-whatsapp",
      "credentials": {
        "whatsAppTriggerApi": {
          "id": "nL8j9VXr95OvYqlC",
          "name": "Frepi bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== EXTRACT WHATSAPP MESSAGE DATA =====\nconst data = $input.first().json;\n\n// Filter: Only process incoming messages\nif (!data.messages || data.messages.length === 0) {\n  console.log('‚è≠Ô∏è Ignoring status notification');\n  return [];\n}\n\nconst message = data.messages[0];\nconst phoneNumber = message.from;\nconst userName = data.contacts[0]?.profile?.name || 'Usuario';\nconst messageId = message.id;\nconst timestamp = message.timestamp;\n\n// Detect unsupported file types\nif (message.type !== 'text') {\n  const unsupportedMessage = `üìé Oi! Percebi que voc√™ enviou um arquivo (${message.type}).\\n\\nPor enquanto, s√≥ consigo processar mensagens de texto. üìù\\n\\nDigite \"menu\" para ver as op√ß√µes dispon√≠veis.`;\n  \n  return [{\n    json: {\n      phone_number: phoneNumber,\n      message: unsupportedMessage,\n      user_name: userName,\n      message_id: messageId,\n      timestamp: timestamp,\n      is_unsupported_file: true,\n      file_type: message.type,\n      output: unsupportedMessage\n    }\n  }];\n}\n\nconst messageText = message.text.body;\n\nconsole.log('üì± Message received from:', phoneNumber);\nconsole.log('üí¨ Content:', messageText);\n\nreturn [{\n  json: {\n    phone_number: phoneNumber,\n    message: messageText,\n    user_name: userName,\n    message_id: messageId,\n    timestamp: new Date().toISOString(),\n    session_id: `${phoneNumber}_${Date.now()}`,\n    is_unsupported_file: false,\n    raw_data: data\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2336,
        1200
      ],
      "id": "extract-data-001",
      "name": "Extract Message Data"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "restaurant_people",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp_number",
              "condition": "eq",
              "keyValue": "={{ $json.phone_number }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2112,
        1200
      ],
      "id": "buscar-usuario-001",
      "name": "Buscar Usuario en DB",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "YaSYB0r907WCaDZK",
          "name": "Frepi Supabase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== PREPARE USER CONTEXT =====\nconst userData = $('Buscar Usuario en DB').all();\nconst messageData = $('Extract Message Data').first().json;\n\nlet userContext = {\n  ...messageData,\n  is_new_user: userData.length === 0\n};\n\nif (userData.length > 0) {\n  const user = userData[0].json;\n  userContext.user_data = user;\n  userContext.restaurant_id = user.restaurant_id;\n  userContext.person_id = user.id;\n  userContext.user_name = user.first_name || messageData.user_name;\n}\n\nconsole.log('üë§ User context:', userContext.is_new_user ? 'NEW USER' : 'EXISTING USER');\n\nreturn [{ json: userContext }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1888,
        1200
      ],
      "id": "prepare-context-001",
      "name": "Prepare User Context"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "supplier-check-001",
              "leftValue": "={{ $json.message.toLowerCase() }}",
              "rightValue": "fornecedor|proveedor|vender|supplier|lista de pre√ßo|lista de precio|distribuidor|sou fornecedor",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1664,
        1200
      ],
      "id": "route-customer-supplier-001",
      "name": "Route: Customer or Supplier?"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.message }}",
        "options": {
          "systemMessage": "# üë§ CUSTOMER JOURNEY AGENT - FREPI\n\n## CONTEXTO\nEres el agente especializado en gestionar restaurantes por WhatsApp. Manejas todo el ciclo desde onboarding hasta compra.\n\n## MISI√ìN\n1. Onboarding de nuevos restaurantes\n2. Configuraci√≥n de preferencias de compra\n3. B√∫squeda y compra de productos\n4. Gesti√≥n de pedidos\n\n## DATOS DEL USUARIO\nNuevo usuario: {{ $('Prepare User Context').first().json.is_new_user }}\n{{ $('Prepare User Context').first().json.user_data ? 'Usuario: ' + $('Prepare User Context').first().json.user_name : 'Sin datos previos' }}\n\n## TOOLS DISPONIBLES\n\n### üìù onboarding_restaurant\n**Descripci√≥n:** Inicia registro de nuevo restaurante.\n**Captura:** nombre restaurante, contacto, ciudad, tipo negocio.\n**USA cuando:** Detectes que es usuario nuevo o cuando pida \"registrar\" o \"cadastro\".\n\n### ‚öôÔ∏è setup_buying_preferences\n**Descripci√≥n:** Configura preferencias de compra.\n**Captura:** marcas preferidas, formatos, frecuencias, restricciones.\n**USA cuando:** Usuario quiera configurar preferencias o diga \"preferencias\", \"configurar\".\n\n### üîé search_products_vector\n**Descripci√≥n:** Busca productos en cat√°logo maestro usando vector search.\n**Retorna:** Productos con precios y disponibilidad.\n**USA cuando:** Usuario mencione productos para comprar (ej: \"quiero tomate\", \"preciso de arroz\").\n\n### üõí build_shopping_cart\n**Descripci√≥n:** Arma carrito con productos seleccionados.\n**Calcula:** Cantidades y totales.\n**USA cuando:** Usuario haya visto productos y diga cantidades o \"quero X unidades\".\n\n### ‚úÖ execute_checkout\n**Descripci√≥n:** Finaliza y confirma el pedido.\n**Crea:** Orden en sistema.\n**USA cuando:** Usuario confirme \"comprar\", \"confirmar pedido\", \"finalizar\".\n\n### üì± show_customer_menu\n**Descripci√≥n:** Muestra men√∫ de opciones para restaurantes.\n**USA cuando:** Usuario pida \"menu\", \"opciones\", \"ayuda\" o \"ajuda\".\n\n## FLUJO T√çPICO\n\n**Nuevo Usuario:**\n1. Detectar que es nuevo\n2. USA onboarding_restaurant\n3. Despu√©s del registro, USA show_customer_menu\n\n**Usuario Comprando:**\n1. USA search_products_vector cuando mencione productos\n2. Usuario selecciona productos y cantidades\n3. USA build_shopping_cart\n4. Usuario confirma\n5. USA execute_checkout\n\n**Usuario Configurando:**\n1. USA setup_buying_preferences\n2. Capturar preferencias paso a paso\n3. Confirmar guardado\n\n## REGLAS IMPORTANTES\n- ‚úÖ Conversaci√≥n natural en portugu√©s de Brasil, no robotizada\n- ‚úÖ UNA pregunta a la vez en onboarding\n- ‚úÖ Confirmar ANTES de checkout\n- ‚úÖ Si usuario cambia de tema, adaptar\n- ‚úÖ Usar emojis relevantes: üõí üîé ‚úÖ üì¶ üçΩÔ∏è\n- ‚ùå NO inventes datos - si no sabes, pregunta\n- ‚ùå NO confirmes pedidos sin autorizaci√≥n expl√≠cita\n\n## TONO\nAmig√°vel, eficiente, como um assistente pessoal de compras brasileiro. Seja breve (m√°ximo 3-4 linhas por mensagem)."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -1120,
        1072
      ],
      "id": "customer-journey-agent-001",
      "name": "Customer Journey Agent"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.message }}",
        "options": {
          "systemMessage": "# üè™ SUPPLIER JOURNEY AGENT - FREPI\n\n## CONTEXTO\nEres el agente especializado en gestionar proveedores. Manejas registro, listas de precios y publicaci√≥n.\n\n## MISI√ìN\n1. Onboarding de nuevos proveedores\n2. Procesamiento de listas de precios\n3. Normalizaci√≥n y validaci√≥n de productos\n4. Publicaci√≥n al cat√°logo maestro\n\n## TOOLS DISPONIBLES\n\n### üìã onboarding_supplier\n**Descripci√≥n:** Inicia registro de nuevo proveedor.\n**Captura:** raz√≥n social, contacto, regi√≥n de cobertura, categor√≠as.\n**USA cuando:** Detectes que es proveedor nuevo o diga \"registrar\", \"cadastrar empresa\".\n\n### üí∞ upload_supplier_prices\n**Descripci√≥n:** Procesa lista de precios del proveedor.\n**Acepta:** CSV, Excel o texto estructurado.\n**Valida:** Formato y completitud.\n**USA cuando:** Proveedor env√≠e precios o diga \"actualizar pre√ßos\", \"lista de pre√ßos\".\n\n### üîß normalize_product_list\n**Descripci√≥n:** Normaliza la lista de productos:\n- Mapea SKUs al cat√°logo maestro\n- Estandariza unidades de medida\n- Elimina duplicados\n- Valida precios an√≥malos\n**USA:** Despu√©s de upload_supplier_prices, autom√°ticamente.\n\n### üì§ publish_to_catalog\n**Descripci√≥n:** Publica lista normalizada al cat√°logo activo.\n**Crea:** Versi√≥n, registra changelog.\n**USA cuando:** Proveedor confirme publicaci√≥n diciendo \"publicar\", \"confirmar\", \"ok\".\n\n### üì± show_supplier_menu\n**Descripci√≥n:** Muestra men√∫ de opciones para proveedores.\n**USA cuando:** Proveedor pida \"menu\", \"op√ß√µes\", \"ajuda\".\n\n## FLUJO T√çPICO\n\n**Nuevo Proveedor:**\n1. USA onboarding_supplier\n2. Capturar datos empresa\n3. USA show_supplier_menu\n\n**Subir Precios:**\n1. USA upload_supplier_prices\n2. Validar formato\n3. USA normalize_product_list\n4. Revisar resultados\n5. USA publish_to_catalog cuando confirme\n\n## REGLAS IMPORTANTES\n- ‚úÖ Validar SIEMPRE antes de publicar\n- ‚úÖ Detectar precios an√≥malos (>50% cambio)\n- ‚úÖ Confirmar publicaci√≥n expl√≠citamente\n- ‚úÖ Mantener historial de versiones\n- ‚úÖ Tono profesional pero amigable\n- ‚ùå NO publiques sin confirmaci√≥n expl√≠cita\n- ‚ùå NO aceptes precios sin validar formato\n\n## FORMATO DE PRECIOS ACEPTADO\nEjemplo texto:\n```\nLeite Piracanjuba 4.50/L\nArroz Tio Jo√£o 5.20/kg\nFeij√£o Camil 6.80/kg\n```\n\nO estructurado:\n```\nFornecedor: Piracanjuba\n- Leite 4.50/L\n- Queijo 18.00/kg\n```\n\n## TONO\nProfissional, eficiente, orientado a resultados comerciais. Use emojis: üí∞ üìã ‚úÖ üìä"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -1120,
        1328
      ],
      "id": "supplier-journey-agent-001",
      "name": "Supplier Journey Agent"
    },
    {
      "parameters": {
        "description": "Inicia o onboarding de um novo restaurante. Captura nome do restaurante, contacto, cidade e tipo de neg√≥cio. Retorna JSON com status e pr√≥ximo passo.",
        "jsCode": "// ===== ONBOARDING RESTAURANT TOOL =====\nconst input = $input.first().json;\nconst message = input.query || input.message || '';\nconst userData = $('Prepare User Context').first().json;\n\n// Check if user already exists\nif (!userData.is_new_user) {\n  return JSON.stringify({\n    status: 'already_registered',\n    message: `Ol√° ${userData.user_name}! üòä\\n\\nVoc√™ j√° est√° cadastrado.\\n\\nDigite \"menu\" para ver as op√ß√µes dispon√≠veis.`\n  });\n}\n\nconst response = {\n  status: 'collecting_data',\n  step: 1,\n  total_steps: 4,\n  fields_collected: [],\n  fields_pending: ['restaurant_name', 'contact_name', 'city', 'business_type'],\n  message: 'üìù *Ol√°! Bem-vindo ao Frepi!*\\n\\nSou seu assistente de compras.\\n\\nPara come√ßar, preciso de alguns dados b√°sicos.\\n\\n*Qual √© o nome do seu restaurante?*',\n  next_action: 'await_restaurant_name'\n};\n\nreturn JSON.stringify(response);"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -1424,
        928
      ],
      "id": "tool-onboarding-restaurant",
      "name": "onboarding_restaurant"
    },
    {
      "parameters": {
        "description": "Configura as prefer√™ncias de compra do restaurante. Captura marcas preferidas, formatos, frequ√™ncia de pedidos e restri√ß√µes especiais.",
        "jsCode": "// ===== SETUP BUYING PREFERENCES TOOL =====\nconst input = $input.first().json;\n\nconst response = {\n  status: 'configuring',\n  preference_fields: [\n    {field: 'preferred_brands', label: 'Marcas preferidas', collected: false},\n    {field: 'preferred_formats', label: 'Formatos (kg, caixa, unidade)', collected: false},\n    {field: 'order_frequency', label: 'Frequ√™ncia de pedidos', collected: false},\n    {field: 'delivery_schedule', label: 'Hor√°rio de entrega preferido', collected: false},\n    {field: 'special_restrictions', label: 'Restri√ß√µes especiais', collected: false}\n  ],\n  current_step: 1,\n  total_steps: 5,\n  message: '‚öôÔ∏è *Configura√ß√£o de Prefer√™ncias*\\n\\nVamos configurar suas prefer√™ncias para oferecer melhores recomenda√ß√µes.\\n\\n*Tem marcas preferidas que sempre usa?*\\n(Ex: Sadia, Nestl√©, Aurora)\\n\\nSe n√£o tem prefer√™ncia, digite \"nenhuma\".',\n  next_action: 'await_brands'\n};\n\nreturn JSON.stringify(response);"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -1296,
        928
      ],
      "id": "tool-setup-preferences",
      "name": "setup_buying_preferences"
    },
    {
      "parameters": {
        "description": "Busca produtos no cat√°logo mestre usando vector search sem√¢ntico. Retorna lista de produtos com pre√ßos, fornecedores e disponibilidade.",
        "jsCode": "// ===== VECTOR SEARCH PRODUCTS TOOL =====\nconst input = $input.first().json;\nconst searchQuery = input.query || input.product || input.message || '';\nconst userData = $('Prepare User Context').first().json;\n\nconsole.log('üîç [Vector Search] Buscando:', searchQuery);\n\n// Generate embedding\nlet queryEmbedding;\ntry {\n  const embeddingResponse = await $http.request({\n    method: 'POST',\n    url: 'https://api.openai.com/v1/embeddings',\n    headers: {\n      'Authorization': `Bearer ${$credentials.openAiApi.apiKey}`,\n      'Content-Type': 'application/json'\n    },\n    body: {\n      model: 'text-embedding-ada-002',\n      input: searchQuery\n    }\n  });\n\n  if (embeddingResponse.statusCode === 200) {\n    queryEmbedding = embeddingResponse.data[0].embedding;\n  } else {\n    throw new Error('Embedding generation failed');\n  }\n} catch (error) {\n  console.error('‚ùå Embedding error:', error);\n  return JSON.stringify({\n    found: false,\n    message: '‚ö†Ô∏è Erro ao buscar produtos. Tente novamente.'\n  });\n}\n\n// Search in Supabase\nlet matchingProducts = [];\ntry {\n  const { data, error } = await $supabase.rpc('match_products_v2', {\n    query_embedding: queryEmbedding,\n    match_threshold: 0.65,\n    match_count: 5\n  });\n\n  if (!error) {\n    matchingProducts = data || [];\n  }\n} catch (error) {\n  console.error('‚ùå Search error:', error);\n}\n\nif (matchingProducts.length === 0) {\n  return JSON.stringify({\n    found: false,\n    message: `üîç N√£o encontrei \"${searchQuery}\" no cat√°logo.\\n\\nTente descrever de outra forma ou digite \"menu\" para ver op√ß√µes.`\n  });\n}\n\n// Format results\nconst message = `üîç *Resultados para \"${searchQuery}\"*\\n\\nEncontrei ${matchingProducts.length} op√ß√µes:\\n\\n` +\n  matchingProducts.map((p, i) => \n    `${i+1}. *${p.product_name}* ${p.unit_type || ''}\\n` +\n    `   ${p.brand ? 'Marca: ' + p.brand : ''}\\n` +\n    `   Relev√¢ncia: ${(p.similarity * 100).toFixed(0)}%`\n  ).join('\\n\\n') +\n  `\\n\\nüí¨ Qual te interessa e quantas unidades precisa?`;\n\nconst response = {\n  found: true,\n  results_count: matchingProducts.length,\n  products: matchingProducts,\n  message: message\n};\n\nreturn JSON.stringify(response);"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -1168,
        928
      ],
      "id": "tool-search-products",
      "name": "search_products_vector",
      "credentials": {
        "openAiApi": {
          "id": "MdAepMtuPO5nFVI0",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "description": "Constr√≥i o carrinho de compras adicionando produtos selecionados pelo usu√°rio. Calcula quantidades, subtotais e total.",
        "jsCode": "// ===== BUILD SHOPPING CART TOOL =====\nconst input = $input.first().json;\nconst userData = $('Prepare User Context').first().json;\n\n// In production: parse user selection and build real cart\n// For now, mock cart structure\n\nconst cart = {\n  cart_id: 'cart-' + Date.now(),\n  session_id: userData.session_id,\n  restaurant_id: userData.restaurant_id,\n  items: [\n    {\n      product_id: 'mock-001',\n      name: 'Tomate Longa Vida 500g',\n      quantity: 3,\n      unit: 'caixas',\n      unit_price: 90.00,\n      subtotal: 270.00\n    }\n  ],\n  subtotal: 270.00,\n  tax: 0,\n  delivery_fee: 0,\n  total: 270.00,\n  status: 'pending_confirmation'\n};\n\nconst message = `üõí *Seu Carrinho*\\n\\n` +\n  cart.items.map(item => \n    `‚Ä¢ *${item.name}*\\n` +\n    `  ${item.quantity} ${item.unit} x R$ ${item.unit_price.toFixed(2)} = R$ ${item.subtotal.toFixed(2)}`\n  ).join('\\n\\n') +\n  `\\n\\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\\n` +\n  `Subtotal: R$ ${cart.subtotal.toFixed(2)}\\n` +\n  `Entrega: R$ ${cart.delivery_fee.toFixed(2)}\\n` +\n  `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\\n` +\n  `*TOTAL: R$ ${cart.total.toFixed(2)}*\\n\\n` +\n  `Quer:\\n` +\n  `1Ô∏è‚É£ Adicionar mais produtos\\n` +\n  `2Ô∏è‚É£ Confirmar pedido\\n` +\n  `3Ô∏è‚É£ Cancelar`;\n\nconst response = {\n  ...cart,\n  message: message\n};\n\nreturn JSON.stringify(response);"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -1040,
        928
      ],
      "id": "tool-build-cart",
      "name": "build_shopping_cart"
    },
    {
      "parameters": {
        "description": "Finaliza o pedido criando a ordem no sistema. Gera n√∫mero de ordem e confirma ao usu√°rio. S√≥ usar quando usu√°rio confirmar explicitamente.",
        "jsCode": "// ===== EXECUTE CHECKOUT TOOL =====\nconst input = $input.first().json;\nconst userData = $('Prepare User Context').first().json;\n\n// In production: Create order in Supabase\nconst orderNumber = 'ORD-' + Date.now();\nconst today = new Date();\nconst deliveryDate = new Date(today);\ndeliveryDate.setDate(deliveryDate.getDate() + 2);\n\nconst order = {\n  order_number: orderNumber,\n  restaurant_id: userData.restaurant_id,\n  status: 'confirmed',\n  total: 270.00,\n  created_at: today.toISOString(),\n  estimated_delivery: deliveryDate.toISOString().split('T')[0],\n  items_count: 3,\n  payment_status: 'pending'\n};\n\nconst message = `‚úÖ *PEDIDO CONFIRMADO*\\n\\n` +\n  `üìã N√∫mero: *${order.order_number}*\\n` +\n  `üí∞ Total: R$ ${order.total.toFixed(2)}\\n` +\n  `üöö Entrega estimada: ${order.estimated_delivery}\\n` +\n  `üì¶ ${order.items_count} produtos\\n\\n` +\n  `Seu pedido est√° em processo!\\n` +\n  `Avisaremos quando estiver pronto.\\n\\n` +\n  `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\\n` +\n  `üí¨ Precisa de algo mais?\\n` +\n  `Digite \"menu\" para ver op√ß√µes.`;\n\nconst response = {\n  success: true,\n  order: order,\n  message: message\n};\n\nreturn JSON.stringify(response);"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -912,
        928
      ],
      "id": "tool-execute-checkout",
      "name": "execute_checkout"
    },
    {
      "parameters": {
        "description": "Mostra o menu principal de op√ß√µes para restaurantes.",
        "jsCode": "// ===== SHOW CUSTOMER MENU TOOL =====\nconst menu = `üçΩÔ∏è *MENU PRINCIPAL - RESTAURANTE*\\n\\n` +\n  `O que quer fazer hoje?\\n\\n` +\n  `1Ô∏è‚É£ üõí *Fazer uma compra*\\n` +\n  `   Buscar produtos e criar pedido\\n\\n` +\n  `2Ô∏è‚É£ ‚öôÔ∏è *Configurar prefer√™ncias*\\n` +\n  `   Definir marcas, formatos, restri√ß√µes\\n\\n` +\n  `3Ô∏è‚É£ üì¶ *Ver meus pedidos*\\n` +\n  `   Consultar estado e hist√≥rico\\n\\n` +\n  `4Ô∏è‚É£ üè™ *Gestionar fornecedores*\\n` +\n  `   Adicionar ou atualizar suppliers\\n\\n` +\n  `Digite o n√∫mero ou descreva o que precisa.`;\n\nreturn JSON.stringify({\n  menu: menu,\n  options: ['comprar', 'configurar', 'pedidos', 'fornecedores']\n});"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -784,
        928
      ],
      "id": "tool-customer-menu",
      "name": "show_customer_menu"
    },
    {
      "parameters": {
        "description": "Inicia o registro de um novo fornecedor. Captura raz√£o social, contacto comercial, regi√£o de cobertura e categorias de produtos.",
        "jsCode": "// ===== ONBOARDING SUPPLIER TOOL =====\nconst response = {\n  status: 'collecting_data',\n  step: 1,\n  total_steps: 4,\n  fields_collected: [],\n  fields_pending: ['company_name', 'contact_name', 'coverage_area', 'product_categories'],\n  message: 'üìã *Registro de Fornecedor*\\n\\n' +\n    'Bem-vindo! Para registrar-se como fornecedor no Frepi, preciso de alguns dados.\\n\\n' +\n    '*Qual √© a raz√£o social da sua empresa?*',\n  next_action: 'await_company_name'\n};\n\nreturn JSON.stringify(response);"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -1296,
        1472
      ],
      "id": "tool-onboarding-supplier",
      "name": "onboarding_supplier"
    },
    {
      "parameters": {
        "description": "Processa e valida lista de pre√ßos do fornecedor. Aceita CSV, Excel ou texto estruturado com formato: Produto | Pre√ßo | Unidade.",
        "jsCode": "// ===== UPLOAD SUPPLIER PRICES TOOL =====\nconst input = $input.first().json;\nconst message = input.query || input.message || '';\n\n// In production: parse file or text\n// Detect format, validate required fields\n\nconst response = {\n  status: 'awaiting_file',\n  accepted_formats: ['csv', 'xlsx', 'text'],\n  required_fields: ['produto', 'pre√ßo', 'unidade'],\n  message: 'üí∞ *Enviar Lista de Pre√ßos*\\n\\n' +\n    'Pode me enviar sua lista nestes formatos:\\n\\n' +\n    'üìÑ *Arquivo CSV/Excel* com colunas:\\n' +\n    '   ‚Ä¢ Produto\\n' +\n    '   ‚Ä¢ Pre√ßo\\n' +\n    '   ‚Ä¢ Unidade (kg, caixa, etc)\\n' +\n    '   ‚Ä¢ SKU (opcional)\\n\\n' +\n    'üìù *Texto estruturado*:\\n' +\n    '   Exemplo:\\n' +\n    '   Tomate 500g | 4.50 | caixa\\n' +\n    '   Cebola 1kg | 3.20 | kg\\n\\n' +\n    'Envie sua lista e vou processar.',\n  next_action: 'await_price_list'\n};\n\nreturn JSON.stringify(response);"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -1168,
        1472
      ],
      "id": "tool-upload-prices",
      "name": "upload_supplier_prices"
    },
    {
      "parameters": {
        "description": "Normaliza a lista de produtos do fornecedor mapeando ao cat√°logo mestre, padronizando unidades e validando pre√ßos.",
        "jsCode": "// ===== NORMALIZE PRODUCT LIST TOOL =====\nconst input = $input.first().json;\n\n// In production: \n// - Vector search to map products\n// - Validate units against standard table\n// - Detect price outliers\n\nconst normalizationResults = {\n  status: 'normalized',\n  products_received: 25,\n  products_mapped: 22,\n  products_new: 3,\n  products_rejected: 0,\n  warnings: [\n    {\n      product: 'Tomate Cherry 250g',\n      issue: 'Pre√ßo 30% maior que m√©dia do mercado',\n      action: 'review_recommended'\n    }\n  ],\n  summary: {\n    total_value: 12500.00,\n    avg_price_change: '+5%',\n    categories_affected: ['Vegetais', 'Frutas', 'L√°cteos']\n  },\n  message: 'üîß *Normaliza√ß√£o Conclu√≠da*\\n\\n' +\n    '‚úÖ 22 produtos mapeados ao cat√°logo\\n' +\n    'üÜï 3 produtos novos detectados\\n' +\n    '‚ö†Ô∏è 1 alerta de pre√ßo\\n\\n' +\n    '*Resumo:*\\n' +\n    '‚Ä¢ Valor total: R$ 12.500,00\\n' +\n    '‚Ä¢ Mudan√ßa m√©dia: +5%\\n' +\n    '‚Ä¢ Categorias: 3\\n\\n' +\n    'Quer revisar os detalhes ou publicar diretamente?',\n  next_action: 'await_confirmation'\n};\n\nreturn JSON.stringify(normalizationResults);"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -1040,
        1472
      ],
      "id": "tool-normalize-list",
      "name": "normalize_product_list"
    },
    {
      "parameters": {
        "description": "Publica a lista normalizada ao cat√°logo ativo criando nova vers√£o e notificando restaurantes afetados.",
        "jsCode": "// ===== PUBLISH TO CATALOG TOOL =====\nconst input = $input.first().json;\n\n// In production:\n// - Create version in catalog_versions table\n// - Update prices in master_list\n// - Notify restaurants using these products\n\nconst version = 'v' + new Date().toISOString().split('T')[0].replace(/-/g, '');\nconst timestamp = new Date().toISOString();\n\nconst publishResult = {\n  success: true,\n  version: version,\n  published_at: timestamp,\n  products_updated: 22,\n  products_added: 3,\n  restaurants_notified: 15,\n  changelog: [\n    {action: 'price_update', count: 18},\n    {action: 'new_product', count: 3},\n    {action: 'availability_change', count: 4}\n  ],\n  message: 'üì§ *LISTA PUBLICADA COM SUCESSO*\\n\\n' +\n    `‚úÖ Vers√£o: *${version}*\\n` +\n    `üìÖ Data: ${new Date().toLocaleDateString('pt-BR')}\\n\\n` +\n    '*Mudan√ßas aplicadas:*\\n' +\n    '‚Ä¢ 22 produtos atualizados\\n' +\n    '‚Ä¢ 3 produtos novos adicionados\\n' +\n    '‚Ä¢ 15 restaurantes notificados\\n\\n' +\n    'üéâ Seus produtos j√° est√£o dispon√≠veis!\\n' +\n    'Os restaurantes podem ver e fazer pedidos.\\n\\n' +\n    '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\\n' +\n    'Digite \"menu\" para mais op√ß√µes.',\n  next_action: 'show_menu'\n};\n\nreturn JSON.stringify(publishResult);"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -912,
        1472
      ],
      "id": "tool-publish-catalog",
      "name": "publish_to_catalog"
    },
    {
      "parameters": {
        "description": "Mostra o menu principal de op√ß√µes para fornecedores.",
        "jsCode": "// ===== SHOW SUPPLIER MENU TOOL =====\nconst menu = `üè™ *MENU PRINCIPAL - FORNECEDOR*\\n\\n` +\n  `Que opera√ß√£o quer realizar?\\n\\n` +\n  `1Ô∏è‚É£ üí∞ *Enviar lista de pre√ßos*\\n` +\n  `   Atualizar produtos e pre√ßos\\n\\n` +\n  `2Ô∏è‚É£ üìã *Ver cat√°logo ativo*\\n` +\n  `   Consultar produtos publicados\\n\\n` +\n  `3Ô∏è‚É£ üìä *Hist√≥rico de vendas*\\n` +\n  `   Ver pedidos recebidos\\n\\n` +\n  `4Ô∏è‚É£ ‚öôÔ∏è *Configurar perfil*\\n` +\n  `   Atualizar dados da empresa\\n\\n` +\n  `Digite o n√∫mero ou descreva o que precisa.`;\n\nreturn JSON.stringify({\n  menu: menu,\n  options: ['pre√ßos', 'cat√°logo', 'vendas', 'perfil']\n});"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -784,
        1472
      ],
      "id": "tool-supplier-menu",
      "name": "show_supplier_menu"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0.3,
          "timeout": 30000,
          "maxRetries": 3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -1424,
        1200
      ],
      "id": "openai-customer-001",
      "name": "OpenAI Chat Customer",
      "credentials": {
        "openAiApi": {
          "id": "MdAepMtuPO5nFVI0",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0.2,
          "timeout": 30000,
          "maxRetries": 3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -1424,
        1456
      ],
      "id": "openai-supplier-001",
      "name": "OpenAI Chat Supplier",
      "credentials": {
        "openAiApi": {
          "id": "MdAepMtuPO5nFVI0",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Extract Message Data').first().json.session_id }}",
        "contextWindowLength": 30
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -1296,
        1200
      ],
      "id": "memory-customer-001",
      "name": "Memory Customer"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Extract Message Data').first().json.session_id }}",
        "contextWindowLength": 30
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -1296,
        1456
      ],
      "id": "memory-supplier-001",
      "name": "Memory Supplier"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('WhatsApp Trigger').first().json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "={{ $('Extract Message Data').first().json.phone_number }}",
        "textBody": "={{ $json.output || $json.message || 'Oi! Algo deu errado. Tente novamente! üòä' }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        -640,
        1200
      ],
      "id": "respond-whatsapp-001",
      "name": "Send WhatsApp Response",
      "credentials": {
        "whatsAppApi": {
          "id": "Jb7XPGihYb3LXtzN",
          "name": "Frepi Account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "WhatsApp Trigger": {
      "main": [
        [
          {
            "node": "Extract Message Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Message Data": {
      "main": [
        [
          {
            "node": "Buscar Usuario en DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Usuario en DB": {
      "main": [
        [
          {
            "node": "Prepare User Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare User Context": {
      "main": [
        [
          {
            "node": "Route: Customer or Supplier?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route: Customer or Supplier?": {
      "main": [
        [
          {
            "node": "Supplier Journey Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Customer Journey Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Customer Journey Agent": {
      "main": [
        [
          {
            "node": "Send WhatsApp Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supplier Journey Agent": {
      "main": [
        [
          {
            "node": "Send WhatsApp Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "onboarding_restaurant": {
      "ai_tool": [
        [
          {
            "node": "Customer Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "setup_buying_preferences": {
      "ai_tool": [
        [
          {
            "node": "Customer Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "search_products_vector": {
      "ai_tool": [
        [
          {
            "node": "Customer Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "build_shopping_cart": {
      "ai_tool": [
        [
          {
            "node": "Customer Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "execute_checkout": {
      "ai_tool": [
        [
          {
            "node": "Customer Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "show_customer_menu": {
      "ai_tool": [
        [
          {
            "node": "Customer Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "onboarding_supplier": {
      "ai_tool": [
        [
          {
            "node": "Supplier Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "upload_supplier_prices": {
      "ai_tool": [
        [
          {
            "node": "Supplier Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "normalize_product_list": {
      "ai_tool": [
        [
          {
            "node": "Supplier Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "publish_to_catalog": {
      "ai_tool": [
        [
          {
            "node": "Supplier Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "show_supplier_menu": {
      "ai_tool": [
        [
          {
            "node": "Supplier Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Customer": {
      "ai_languageModel": [
        [
          {
            "node": "Customer Journey Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Supplier": {
      "ai_languageModel": [
        [
          {
            "node": "Supplier Journey Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Memory Customer": {
      "ai_memory": [
        [
          {
            "node": "Customer Journey Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Memory Supplier": {
      "ai_memory": [
        [
          {
            "node": "Supplier Journey Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "frepi-mvp2-full-v1",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "49b8809ac9c6d78ac189292d079f6fecdaf436806e595e6107033a10240b1fea"
  },
  "id": "FrepiMVP2Full",
  "tags": [
    {
      "id": "frepi-v2-architecture",
      "name": "frepi-v2-full"
    }
  ]
}
