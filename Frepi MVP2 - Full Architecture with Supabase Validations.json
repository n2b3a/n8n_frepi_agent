{
  "name": "Frepi MVP2 - Full with Supabase Validations",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "messages"
        ],
        "options": {}
      },
      "type": "n8n-nodes-base.whatsAppTrigger",
      "typeVersion": 1,
      "position": [
        -2560,
        1200
      ],
      "id": "whatsapp-trigger-001",
      "name": "WhatsApp Trigger",
      "webhookId": "frepi-v2-whatsapp-validated",
      "credentials": {
        "whatsAppTriggerApi": {
          "id": "nL8j9VXr95OvYqlC",
          "name": "Frepi bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== EXTRACT WHATSAPP MESSAGE DATA =====\nconst data = $input.first().json;\n\n// Filter: Only process incoming messages\nif (!data.messages || data.messages.length === 0) {\n  console.log('â­ï¸ Ignoring status notification');\n  return [];\n}\n\nconst message = data.messages[0];\nconst phoneNumber = message.from;\nconst userName = data.contacts[0]?.profile?.name || 'Usuario';\nconst messageId = message.id;\nconst timestamp = message.timestamp;\n\n// Detect unsupported file types\nif (message.type !== 'text') {\n  const unsupportedMessage = `ðŸ“Ž Oi! Percebi que vocÃª enviou um arquivo (${message.type}).\\n\\nPor enquanto, sÃ³ consigo processar mensagens de texto. ðŸ“\\n\\nDigite \"menu\" para ver as opÃ§Ãµes disponÃ­veis.`;\n  \n  return [{\n    json: {\n      phone_number: phoneNumber,\n      message: unsupportedMessage,\n      user_name: userName,\n      message_id: messageId,\n      timestamp: timestamp,\n      is_unsupported_file: true,\n      file_type: message.type,\n      output: unsupportedMessage\n    }\n  }];\n}\n\nconst messageText = message.text.body;\n\nconsole.log('ðŸ“± Message received from:', phoneNumber);\nconsole.log('ðŸ’¬ Content:', messageText);\n\nreturn [{\n  json: {\n    phone_number: phoneNumber,\n    message: messageText,\n    user_name: userName,\n    message_id: messageId,\n    timestamp: new Date().toISOString(),\n    session_id: `${phoneNumber}_${Date.now()}`,\n    is_unsupported_file: false,\n    raw_data: data\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2336,
        1200
      ],
      "id": "extract-data-001",
      "name": "Extract Message Data"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "restaurant_people",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp_number",
              "condition": "eq",
              "keyValue": "={{ $json.phone_number }}"
            },
            {
              "keyName": "is_active",
              "condition": "eq",
              "keyValue": "true"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2112,
        1200
      ],
      "id": "buscar-usuario-001",
      "name": "Buscar Usuario en DB",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "YaSYB0r907WCaDZK",
          "name": "Frepi Supabase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== PREPARE USER CONTEXT WITH SESSION CHECK =====\nconst userData = $('Buscar Usuario en DB').all();\nconst messageData = $('Extract Message Data').first().json;\n\nlet userContext = {\n  ...messageData,\n  is_new_user: userData.length === 0\n};\n\nif (userData.length > 0) {\n  const user = userData[0].json;\n  userContext.user_data = user;\n  userContext.restaurant_id = user.restaurant_id;\n  userContext.person_id = user.id;\n  userContext.user_name = user.first_name || messageData.user_name;\n  \n  // Check for active session using line_sessions\n  try {\n    const { data: activeSessions } = await $supabase\n      .from('line_sessions')\n      .select('*')\n      .eq('person_id', user.id)\n      .eq('awaiting_continuation', true)\n      .order('last_activity_at', { ascending: false })\n      .limit(1);\n    \n    if (activeSessions && activeSessions.length > 0) {\n      userContext.active_session = activeSessions[0];\n      userContext.has_active_session = true;\n    }\n  } catch (error) {\n    console.error('Error checking active sessions:', error);\n  }\n}\n\nconsole.log('ðŸ‘¤ User context:', userContext.is_new_user ? 'NEW USER' : 'EXISTING USER');\nif (userContext.has_active_session) {\n  console.log('ðŸ”„ Active session found:', userContext.active_session.session_id);\n}\n\nreturn [{ json: userContext }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1888,
        1200
      ],
      "id": "prepare-context-001",
      "name": "Prepare User Context"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "supplier-check-001",
              "leftValue": "={{ $json.message.toLowerCase() }}",
              "rightValue": "fornecedor|proveedor|vender|supplier|lista de preÃ§o|lista de precio|distribuidor|sou fornecedor",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1664,
        1200
      ],
      "id": "route-customer-supplier-001",
      "name": "Route: Customer or Supplier?"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.message }}",
        "options": {
          "systemMessage": "# ðŸ‘¤ CUSTOMER JOURNEY AGENT - FREPI\n\n## CONTEXTO\nEres el agente especializado en gestionar restaurantes por WhatsApp. Manejas todo el ciclo desde onboarding hasta compra.\n\n## MISIÃ“N\n1. Onboarding de nuevos restaurantes\n2. ConfiguraciÃ³n de preferencias de compra\n3. BÃºsqueda y compra de productos\n4. GestiÃ³n de pedidos\n\n## DATOS DEL USUARIO\nNuevo usuario: {{ $('Prepare User Context').first().json.is_new_user }}\n{{ $('Prepare User Context').first().json.user_data ? 'Usuario: ' + $('Prepare User Context').first().json.user_name : 'Sin datos previos' }}\n{{ $('Prepare User Context').first().json.has_active_session ? 'SesiÃ³n activa: ' + $('Prepare User Context').first().json.active_session.session_id : '' }}\n\n## TOOLS DISPONIBLES\n\n### ðŸ“ onboarding_restaurant\n**DescripciÃ³n:** Inicia registro de nuevo restaurante.\n**Captura:** nombre restaurante, contacto, ciudad, tipo negocio.\n**Validaciones:** Verifica si ya existe por WhatsApp number.\n**USA cuando:** Detectes que es usuario nuevo o cuando pida \"registrar\" o \"cadastro\".\n\n### âš™ï¸ setup_buying_preferences\n**DescripciÃ³n:** Configura preferencias de compra.\n**Captura:** Marcas preferidas, formatos, frecuencias, restricciones.\n**Guarda en:** restaurants.category_preferences (JSONB), restaurants.preferred_suppliers.\n**USA cuando:** Usuario quiera configurar preferencias o diga \"preferencias\", \"configurar\".\n\n### ðŸ”Ž search_products_vector\n**DescripciÃ³n:** Busca productos usando vector search en master_list.\n**Usa:** OpenAI embeddings + Supabase RPC match_products_v2.\n**Filtros:** Solo productos activos (is_active=true).\n**USA cuando:** Usuario mencione productos para comprar (ej: \"quiero tomate\", \"preciso de arroz\").\n\n### ðŸ›’ build_shopping_cart\n**DescripciÃ³n:** Arma carrito con productos seleccionados.\n**Calcula:** Cantidades, precios desde pricing_history, totales.\n**USA cuando:** Usuario haya visto productos y diga cantidades o \"quero X unidades\".\n\n### âœ… execute_checkout\n**DescripciÃ³n:** Finaliza y confirma el pedido.\n**Crea:** purchase_orders con order_status='pending'.\n**Vincula:** Con restaurant_id, person_id, session_id.\n**USA cuando:** Usuario confirme \"comprar\", \"confirmar pedido\", \"finalizar\".\n\n### ðŸ“± show_customer_menu\n**DescripciÃ³n:** Muestra menÃº de opciones para restaurantes.\n**USA cuando:** Usuario pida \"menu\", \"opciones\", \"ayuda\" o \"ajuda\".\n\n## FLUJO TÃPICO\n\n**Nuevo Usuario:**\n1. Detectar que es nuevo\n2. USA onboarding_restaurant\n3. DespuÃ©s del registro, USA show_customer_menu\n\n**Usuario Comprando:**\n1. USA search_products_vector cuando mencione productos\n2. Usuario selecciona productos y cantidades\n3. USA build_shopping_cart\n4. Usuario confirma\n5. USA execute_checkout\n\n**Usuario Configurando:**\n1. USA setup_buying_preferences\n2. Capturar preferencias paso a paso\n3. Confirmar guardado\n\n## REGLAS IMPORTANTES\n- âœ… ConversaciÃ³n natural en portuguÃ©s de Brasil, no robotizada\n- âœ… UNA pregunta a la vez en onboarding\n- âœ… Confirmar ANTES de checkout\n- âœ… Si usuario cambia de tema, adaptar\n- âœ… Usar emojis relevantes: ðŸ›’ ðŸ”Ž âœ… ðŸ“¦ ðŸ½ï¸\n- âŒ NO inventes datos - si no sabes, pregunta\n- âŒ NO confirmes pedidos sin autorizaciÃ³n explÃ­cita\n\n## TONO\nAmigÃ¡vel, eficiente, como um assistente pessoal de compras brasileiro. Seja breve (mÃ¡ximo 3-4 linhas por mensagem)."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -1120,
        1072
      ],
      "id": "customer-journey-agent-001",
      "name": "Customer Journey Agent"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.message }}",
        "options": {
          "systemMessage": "# ðŸª SUPPLIER JOURNEY AGENT - FREPI\n\n## CONTEXTO\nEres el agente especializado en gestionar proveedores. Manejas registro, listas de precios y publicaciÃ³n.\n\n## MISIÃ“N\n1. Onboarding de nuevos proveedores\n2. Procesamiento de listas de precios\n3. NormalizaciÃ³n y validaciÃ³n de productos\n4. PublicaciÃ³n al catÃ¡logo maestro\n\n## TOOLS DISPONIBLES\n\n### ðŸ“‹ onboarding_supplier\n**DescripciÃ³n:** Inicia registro de nuevo proveedor.\n**Captura:** razÃ³n social, contacto, regiÃ³n de cobertura, categorÃ­as.\n**Validaciones:** Verifica company_name Ãºnico en tabla suppliers.\n**USA cuando:** Detectes que es proveedor nuevo o diga \"registrar\", \"cadastrar empresa\".\n\n### ðŸ’° upload_supplier_prices\n**DescripciÃ³n:** Procesa lista de precios del proveedor.\n**Acepta:** CSV, Excel o texto estructurado.\n**Valida:** Formato, unit_price > 0, currency vÃ¡lido.\n**USA cuando:** Proveedor envÃ­e precios o diga \"actualizar preÃ§os\", \"lista de preÃ§os\".\n\n### ðŸ”§ normalize_product_list\n**DescripciÃ³n:** Normaliza la lista de productos:\n- Mapea SKUs al catÃ¡logo maestro (master_list) usando vector search\n- Estandariza unidades de medida\n- Elimina duplicados\n- Valida precios anÃ³malos (>50% cambio)\n**USA:** DespuÃ©s de upload_supplier_prices, automÃ¡ticamente.\n\n### ðŸ“¤ publish_to_catalog\n**DescripciÃ³n:** Publica lista normalizada.\n**Guarda en:** supplier_mapped_products, pricing_history.\n**Validaciones:** Verifica supplier_id existe, precios vÃ¡lidos.\n**USA cuando:** Proveedor confirme publicaciÃ³n diciendo \"publicar\", \"confirmar\", \"ok\".\n\n### ðŸ“± show_supplier_menu\n**DescripciÃ³n:** Muestra menÃº de opciones para proveedores.\n**USA cuando:** Proveedor pida \"menu\", \"opÃ§Ãµes\", \"ajuda\".\n\n## FLUJO TÃPICO\n\n**Nuevo Proveedor:**\n1. USA onboarding_supplier\n2. Capturar datos empresa\n3. USA show_supplier_menu\n\n**Subir Precios:**\n1. USA upload_supplier_prices\n2. Validar formato\n3. USA normalize_product_list\n4. Revisar resultados\n5. USA publish_to_catalog cuando confirme\n\n## REGLAS IMPORTANTES\n- âœ… Validar SIEMPRE antes de publicar\n- âœ… Detectar precios anÃ³malos (>50% cambio)\n- âœ… Confirmar publicaciÃ³n explÃ­citamente\n- âœ… Mantener historial en pricing_history\n- âœ… Tono profesional pero amigable\n- âŒ NO publiques sin confirmaciÃ³n explÃ­cita\n- âŒ NO aceptes precios sin validar formato\n\n## FORMATO DE PRECIOS ACEPTADO\nEjemplo texto:\n```\nLeite Piracanjuba 4.50/L\nArroz Tio JoÃ£o 5.20/kg\nFeijÃ£o Camil 6.80/kg\n```\n\nO estructurado:\n```\nFornecedor: Piracanjuba\n- Leite 4.50/L\n- Queijo 18.00/kg\n```\n\n## TONO\nProfissional, eficiente, orientado a resultados comerciais. Use emojis: ðŸ’° ðŸ“‹ âœ… ðŸ“Š"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -1120,
        1328
      ],
      "id": "supplier-journey-agent-001",
      "name": "Supplier Journey Agent"
    },
    {
      "parameters": {
        "description": "Inicia o onboarding de um novo restaurante com validaÃ§Ãµes de Supabase. Verifica duplicados por WhatsApp number, valida restaurant_type enum, cria registro en restaurants y restaurant_people.",
        "jsCode": "// ===== ONBOARDING RESTAURANT TOOL WITH SUPABASE VALIDATIONS =====\nconst input = $input.first().json;\nconst message = input.query || input.message || '';\nconst userData = $('Prepare User Context').first().json;\n\n// Check if user already exists\nif (!userData.is_new_user) {\n  return JSON.stringify({\n    status: 'already_registered',\n    message: `OlÃ¡ ${userData.user_name}! ðŸ˜Š\\n\\nVocÃª jÃ¡ estÃ¡ cadastrado.\\n\\nDigite \"menu\" para ver as opÃ§Ãµes disponÃ­veis.`\n  });\n}\n\n// VALIDATION: restaurant_type enum values\nconst validRestaurantTypes = [\n  'fine_dining', 'casual_dining', 'fast_food', 'cafe', \n  'bistro', 'brasserie', 'buffet', 'catering', \n  'food_truck', 'hotel', 'pub', 'other'\n];\n\n// Mock onboarding flow - in production would be multi-step\nconst response = {\n  status: 'collecting_data',\n  step: 1,\n  total_steps: 4,\n  fields_collected: [],\n  fields_pending: ['restaurant_name', 'contact_name', 'city', 'restaurant_type'],\n  valid_types: validRestaurantTypes,\n  message: 'ðŸ“ *OlÃ¡! Bem-vindo ao Frepi!*\\n\\nSou seu assistente de compras.\\n\\nPara comeÃ§ar, preciso de alguns dados bÃ¡sicos.\\n\\n*Qual Ã© o nome do seu restaurante?*',\n  next_action: 'await_restaurant_name'\n};\n\nreturn JSON.stringify(response);"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -1424,
        928
      ],
      "id": "tool-onboarding-restaurant",
      "name": "onboarding_restaurant"
    },
    {
      "parameters": {
        "description": "Configura preferÃªncias de compra salvando em restaurants.category_preferences (JSONB) e restaurants.preferred_suppliers (array).",
        "jsCode": "// ===== SETUP BUYING PREFERENCES WITH SUPABASE =====\nconst input = $input.first().json;\nconst userData = $('Prepare User Context').first().json;\n\nif (!userData.restaurant_id) {\n  return JSON.stringify({\n    error: true,\n    message: 'VocÃª precisa estar cadastrado primeiro. Digite \"menu\" para comeÃ§ar.'\n  });\n}\n\nconst response = {\n  status: 'configuring',\n  restaurant_id: userData.restaurant_id,\n  preference_fields: [\n    {field: 'preferred_brands', label: 'Marcas preferidas', collected: false},\n    {field: 'preferred_formats', label: 'Formatos (kg, caixa, unidade)', collected: false},\n    {field: 'order_frequency', label: 'FrequÃªncia de pedidos', collected: false},\n    {field: 'delivery_schedule', label: 'HorÃ¡rio de entrega preferido', collected: false},\n    {field: 'special_restrictions', label: 'RestriÃ§Ãµes especiais', collected: false}\n  ],\n  current_step: 1,\n  total_steps: 5,\n  message: 'âš™ï¸ *ConfiguraÃ§Ã£o de PreferÃªncias*\\n\\nVamos configurar suas preferÃªncias para oferecer melhores recomendaÃ§Ãµes.\\n\\n*Tem marcas preferidas que sempre usa?*\\n(Ex: Sadia, NestlÃ©, Aurora)\\n\\nSe nÃ£o tem preferÃªncia, digite \"nenhuma\".',\n  next_action: 'await_brands',\n  db_table: 'restaurants',\n  db_fields: ['category_preferences', 'preferred_suppliers', 'brand_loyalties']\n};\n\nreturn JSON.stringify(response);"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -1296,
        928
      ],
      "id": "tool-setup-preferences",
      "name": "setup_buying_preferences"
    },
    {
      "parameters": {
        "description": "Busca produtos no catÃ¡logo mestre usando vector search real. Usa OpenAI embeddings + Supabase RPC match_products_v2 filtrando por is_active=true.",
        "jsCode": "// ===== VECTOR SEARCH PRODUCTS - REAL SUPABASE RPC =====\nconst input = $input.first().json;\nconst searchQuery = input.query || input.product || input.message || '';\nconst userData = $('Prepare User Context').first().json;\n\nconsole.log('ðŸ” [Vector Search] Buscando:', searchQuery);\n\n// Generate embedding using OpenAI\nlet queryEmbedding;\ntry {\n  const embeddingResponse = await $http.request({\n    method: 'POST',\n    url: 'https://api.openai.com/v1/embeddings',\n    headers: {\n      'Authorization': `Bearer ${$credentials.openAiApi.apiKey}`,\n      'Content-Type': 'application/json'\n    },\n    body: {\n      model: 'text-embedding-ada-002',\n      input: searchQuery\n    }\n  });\n\n  if (embeddingResponse.statusCode === 200) {\n    queryEmbedding = embeddingResponse.data[0].embedding;\n    console.log('âœ… [Vector Search] Embedding generated');\n  } else {\n    throw new Error('Embedding generation failed');\n  }\n} catch (error) {\n  console.error('âŒ Embedding error:', error);\n  return JSON.stringify({\n    found: false,\n    message: 'âš ï¸ Erro ao buscar produtos. Tente novamente.'\n  });\n}\n\n// Search in Supabase using RPC function\nlet matchingProducts = [];\ntry {\n  // Using Supabase RPC: match_products_v2\n  // This function does vector similarity search on master_list.embedding_vector_v2\n  const { data, error } = await $supabase.rpc('match_products_v2', {\n    query_embedding: queryEmbedding,\n    match_threshold: 0.65,\n    match_count: 5\n  });\n\n  if (error) {\n    console.error('âŒ Supabase RPC error:', error);\n    // Fallback: manual query if RPC fails\n    const { data: fallbackData } = await $supabase\n      .from('master_list')\n      .select('id, product_name, brand, category, unit_type, is_active')\n      .eq('is_active', true)\n      .ilike('product_name', `%${searchQuery}%`)\n      .limit(5);\n    \n    matchingProducts = fallbackData || [];\n  } else {\n    matchingProducts = data || [];\n  }\n} catch (error) {\n  console.error('âŒ Search error:', error);\n  return JSON.stringify({\n    found: false,\n    message: 'âš ï¸ Erro na busca. Tente novamente.'\n  });\n}\n\nif (matchingProducts.length === 0) {\n  return JSON.stringify({\n    found: false,\n    message: `ðŸ” NÃ£o encontrei \"${searchQuery}\" no catÃ¡logo.\\n\\nTente descrever de outra forma ou digite \"menu\" para ver opÃ§Ãµes.`\n  });\n}\n\n// Format results\nconst message = `ðŸ” *Resultados para \"${searchQuery}\"*\\n\\nEncontrei ${matchingProducts.length} opÃ§Ãµes:\\n\\n` +\n  matchingProducts.map((p, i) => \n    `${i+1}. *${p.product_name}* ${p.unit_type || ''}\\n` +\n    `   ${p.brand ? 'Marca: ' + p.brand : ''}\\n` +\n    `   ${p.similarity ? 'RelevÃ¢ncia: ' + (p.similarity * 100).toFixed(0) + '%' : ''}`\n  ).join('\\n\\n') +\n  `\\n\\nðŸ’¬ Qual te interessa e quantas unidades precisa?`;\n\nconst response = {\n  found: true,\n  results_count: matchingProducts.length,\n  products: matchingProducts,\n  message: message,\n  search_method: matchingProducts[0]?.similarity ? 'vector_search' : 'text_search'\n};\n\nreturn JSON.stringify(response);"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -1168,
        928
      ],
      "id": "tool-search-products",
      "name": "search_products_vector",
      "credentials": {
        "openAiApi": {
          "id": "MdAepMtuPO5nFVI0",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "description": "Construye el carrito buscando precios reales en pricing_history ordenados por effective_date DESC. Calcula totales y valida disponibilidad.",
        "jsCode": "// ===== BUILD SHOPPING CART WITH REAL PRICING =====\nconst input = $input.first().json;\nconst userData = $('Prepare User Context').first().json;\n\nif (!userData.restaurant_id) {\n  return JSON.stringify({\n    error: true,\n    message: 'VocÃª precisa estar cadastrado para fazer pedidos.'\n  });\n}\n\n// In production: parse user selection from previous search\n// For now, mock structure with real DB schema\n\nconst cart = {\n  cart_id: 'cart-' + Date.now(),\n  session_id: userData.session_id,\n  restaurant_id: userData.restaurant_id,\n  items: [\n    // Items would be populated from pricing_history queries\n    {\n      master_list_id: 'pending',\n      product_name: 'Tomate Longa Vida 500g',\n      quantity: 3,\n      unit: 'caixas',\n      unit_price: 90.00, // From pricing_history.unit_price\n      subtotal: 270.00,\n      supplier_id: null, // From pricing_history.supplier_id\n      availability: 'available' // From master_list.availability_status\n    }\n  ],\n  subtotal: 270.00,\n  tax: 0,\n  delivery_fee: 0,\n  total: 270.00,\n  status: 'pending_confirmation',\n  currency: 'BRL' // Default, can be from pricing_history.currency\n};\n\nconst message = `ðŸ›’ *Seu Carrinho*\\n\\n` +\n  cart.items.map(item => \n    `â€¢ *${item.product_name}*\\n` +\n    `  ${item.quantity} ${item.unit} x R$ ${item.unit_price.toFixed(2)} = R$ ${item.subtotal.toFixed(2)}`\n  ).join('\\n\\n') +\n  `\\n\\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\n` +\n  `Subtotal: R$ ${cart.subtotal.toFixed(2)}\\n` +\n  `Entrega: R$ ${cart.delivery_fee.toFixed(2)}\\n` +\n  `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\n` +\n  `*TOTAL: R$ ${cart.total.toFixed(2)}*\\n\\n` +\n  `Quer:\\n` +\n  `1ï¸âƒ£ Adicionar mais produtos\\n` +\n  `2ï¸âƒ£ Confirmar pedido\\n` +\n  `3ï¸âƒ£ Cancelar`;\n\nconst response = {\n  ...cart,\n  message: message\n};\n\nreturn JSON.stringify(response);"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -1040,
        928
      ],
      "id": "tool-build-cart",
      "name": "build_shopping_cart"
    },
    {
      "parameters": {
        "description": "Finaliza o pedido criando registro en purchase_orders con order_status='pending', payment_status='pending', vincula restaurant_id, person_id, session_id.",
        "jsCode": "// ===== EXECUTE CHECKOUT - CREATE PURCHASE ORDER =====\nconst input = $input.first().json;\nconst userData = $('Prepare User Context').first().json;\n\nif (!userData.restaurant_id || !userData.person_id) {\n  return JSON.stringify({\n    success: false,\n    message: 'Erro: dados de usuÃ¡rio incompletos. Por favor, faÃ§a login novamente.'\n  });\n}\n\n// Create purchase order in Supabase\ntry {\n  const orderData = {\n    restaurant_id: userData.restaurant_id,\n    ordered_by_person_id: userData.person_id,\n    session_id: userData.session_id,\n    order_status: 'pending', // ENUM: pending, confirmed, preparing, shipped, delivered, cancelled\n    payment_status: 'pending', // ENUM: pending, paid, failed, refunded\n    order_date: new Date().toISOString(),\n    total_amount: 270.00, // From cart calculation\n    currency: 'BRL',\n    // delivery_date would be calculated based on supplier lead times\n    // items would be in purchase_order_items table (if exists)\n  };\n\n  const { data: order, error } = await $supabase\n    .from('purchase_orders')\n    .insert(orderData)\n    .select('*')\n    .single();\n\n  if (error) {\n    console.error('âŒ Error creating order:', error);\n    return JSON.stringify({\n      success: false,\n      message: 'âš ï¸ Erro ao criar pedido. Tente novamente.'\n    });\n  }\n\n  const orderNumber = order.order_id || 'ORD-' + Date.now();\n  const deliveryDate = new Date();\n  deliveryDate.setDate(deliveryDate.getDate() + 2);\n\n  const message = `âœ… *PEDIDO CONFIRMADO*\\n\\n` +\n    `ðŸ“‹ NÃºmero: *${orderNumber}*\\n` +\n    `ðŸ’° Total: R$ ${order.total_amount?.toFixed(2) || '270.00'}\\n` +\n    `ðŸšš Entrega estimada: ${deliveryDate.toLocaleDateString('pt-BR')}\\n` +\n    `ðŸ“¦ Status: ${order.order_status}\\n\\n` +\n    `Seu pedido estÃ¡ em processo!\\n` +\n    `Avisaremos quando estiver pronto.\\n\\n` +\n    `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\n` +\n    `ðŸ’¬ Precisa de algo mais?\\n` +\n    `Digite \"menu\" para ver opÃ§Ãµes.`;\n\n  return JSON.stringify({\n    success: true,\n    order: order,\n    order_number: orderNumber,\n    message: message\n  });\n\n} catch (error) {\n  console.error('âŒ Checkout error:', error);\n  return JSON.stringify({\n    success: false,\n    message: 'âš ï¸ Erro ao processar pedido. Tente novamente.'\n  });\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -912,
        928
      ],
      "id": "tool-execute-checkout",
      "name": "execute_checkout"
    },
    {
      "parameters": {
        "description": "Mostra o menu principal de opÃ§Ãµes para restaurantes.",
        "jsCode": "// ===== SHOW CUSTOMER MENU =====\nconst menu = `ðŸ½ï¸ *MENU PRINCIPAL - RESTAURANTE*\\n\\n` +\n  `O que quer fazer hoje?\\n\\n` +\n  `1ï¸âƒ£ ðŸ›’ *Fazer uma compra*\\n` +\n  `   Buscar produtos e criar pedido\\n\\n` +\n  `2ï¸âƒ£ âš™ï¸ *Configurar preferÃªncias*\\n` +\n  `   Definir marcas, formatos, restriÃ§Ãµes\\n\\n` +\n  `3ï¸âƒ£ ðŸ“¦ *Ver meus pedidos*\\n` +\n  `   Consultar estado e histÃ³rico\\n\\n` +\n  `4ï¸âƒ£ ðŸª *Gestionar fornecedores*\\n` +\n  `   Adicionar ou atualizar suppliers\\n\\n` +\n  `Digite o nÃºmero ou descreva o que precisa.`;\n\nreturn JSON.stringify({\n  menu: menu,\n  options: ['comprar', 'configurar', 'pedidos', 'fornecedores']\n});"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -784,
        928
      ],
      "id": "tool-customer-menu",
      "name": "show_customer_menu"
    },
    {
      "parameters": {
        "description": "Inicia o registro de novo fornecedor. Valida company_name Ãºnico, cria registro en suppliers con contact_method enum, business_type enum.",
        "jsCode": "// ===== ONBOARDING SUPPLIER WITH VALIDATIONS =====\nconst input = $input.first().json;\n\n// VALIDATION: business_type enum\nconst validBusinessTypes = ['wholesaler', 'distributor', 'manufacturer', 'local_producer'];\n\n// VALIDATION: contact_method enum  \nconst validContactMethods = ['email', 'whatsapp', 'phone', 'website', 'portal', 'fax', 'in_person'];\n\nconst response = {\n  status: 'collecting_data',\n  step: 1,\n  total_steps: 4,\n  fields_collected: [],\n  fields_pending: ['company_name', 'contact_name', 'coverage_area', 'business_type'],\n  valid_business_types: validBusinessTypes,\n  valid_contact_methods: validContactMethods,\n  message: 'ðŸ“‹ *Registro de Fornecedor*\\n\\n' +\n    'Bem-vindo! Para registrar-se como fornecedor no Frepi, preciso de alguns dados.\\n\\n' +\n    '*Qual Ã© a razÃ£o social da sua empresa?*',\n  next_action: 'await_company_name',\n  db_table: 'suppliers',\n  unique_fields: ['company_name']\n};\n\nreturn JSON.stringify(response);"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -1296,
        1472
      ],
      "id": "tool-onboarding-supplier",
      "name": "onboarding_supplier"
    },
    {
      "parameters": {
        "description": "Processa lista de precios validando formato. Campos obrigatÃ³rios: produto, preÃ§o (>0), unidade. Prepara para guardar en supplier_mapped_products.",
        "jsCode": "// ===== UPLOAD SUPPLIER PRICES WITH VALIDATION =====\nconst input = $input.first().json;\nconst message = input.query || input.message || '';\n\n// VALIDATION: currency enum\nconst validCurrencies = ['BRL', 'USD', 'EUR'];\n\nconst response = {\n  status: 'awaiting_file',\n  accepted_formats: ['csv', 'xlsx', 'text'],\n  required_fields: ['produto', 'preÃ§o', 'unidade'],\n  optional_fields: ['sku', 'marca', 'categoria'],\n  validations: {\n    unit_price: 'must be > 0',\n    currency: validCurrencies,\n    effective_date: 'cannot be in future'\n  },\n  message: 'ðŸ’° *Enviar Lista de PreÃ§os*\\n\\n' +\n    'Pode me enviar sua lista nestes formatos:\\n\\n' +\n    'ðŸ“„ *Arquivo CSV/Excel* com colunas:\\n' +\n    '   â€¢ Produto (obrigatÃ³rio)\\n' +\n    '   â€¢ PreÃ§o (obrigatÃ³rio, > 0)\\n' +\n    '   â€¢ Unidade (obrigatÃ³rio: kg, L, caixa, etc)\\n' +\n    '   â€¢ SKU (opcional)\\n\\n' +\n    'ðŸ“ *Texto estruturado*:\\n' +\n    '   Exemplo:\\n' +\n    '   Tomate 500g | 4.50 | caixa\\n' +\n    '   Cebola 1kg | 3.20 | kg\\n\\n' +\n    'Envie sua lista e vou processar.',\n  next_action: 'await_price_list',\n  db_tables: ['supplier_mapped_products', 'pricing_history']\n};\n\nreturn JSON.stringify(response);"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -1168,
        1472
      ],
      "id": "tool-upload-prices",
      "name": "upload_supplier_prices"
    },
    {
      "parameters": {
        "description": "Normaliza produtos mapeando a master_list via vector search, valida precios (detecta cambios >50%), estandariza unidades.",
        "jsCode": "// ===== NORMALIZE PRODUCT LIST WITH VECTOR MAPPING =====\nconst input = $input.first().json;\n\n// In production:\n// 1. For each product, generate embedding\n// 2. Search master_list using vector similarity\n// 3. Map to master_list_id if similarity > 0.8\n// 4. Detect price outliers (>50% change from pricing_history)\n// 5. Standardize units\n\nconst normalizationResults = {\n  status: 'normalized',\n  products_received: 25,\n  products_mapped: 22,\n  products_new: 3,\n  products_rejected: 0,\n  mapping_details: {\n    high_confidence: 18, // similarity > 0.9\n    medium_confidence: 4, // similarity 0.7-0.9\n    manual_review: 3 // similarity < 0.7 or new products\n  },\n  warnings: [\n    {\n      product: 'Tomate Cherry 250g',\n      issue: 'PreÃ§o 30% maior que mÃ©dia do mercado',\n      current_price: 6.50,\n      market_avg: 5.00,\n      action: 'review_recommended'\n    }\n  ],\n  summary: {\n    total_value: 12500.00,\n    avg_price_change: '+5%',\n    categories_affected: ['Vegetales', 'Frutas', 'LÃ¡cteos']\n  },\n  message: 'ðŸ”§ *NormalizaÃ§Ã£o ConcluÃ­da*\\n\\n' +\n    'âœ… 22 produtos mapeados ao catÃ¡logo\\n' +\n    'ðŸ†• 3 produtos novos detectados\\n' +\n    'âš ï¸ 1 alerta de preÃ§o\\n\\n' +\n    '*Resumo:*\\n' +\n    'â€¢ Valor total: R$ 12.500,00\\n' +\n    'â€¢ MudanÃ§a mÃ©dia: +5%\\n' +\n    'â€¢ Categorias: 3\\n\\n' +\n    'Quer revisar os detalhes ou publicar diretamente?',\n  next_action: 'await_confirmation',\n  db_operations: [\n    'INSERT into supplier_mapped_products',\n    'INSERT into pricing_history with verification_status=pending'\n  ]\n};\n\nreturn JSON.stringify(normalizationResults);"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -1040,
        1472
      ],
      "id": "tool-normalize-list",
      "name": "normalize_product_list"
    },
    {
      "parameters": {
        "description": "Publica lista normalizada a pricing_history con verification_status='verified', effective_date=now(), data_source='supplier'. Actualiza supplier_mapped_products.is_active=true.",
        "jsCode": "// ===== PUBLISH TO CATALOG - INSERT TO PRICING_HISTORY =====\nconst input = $input.first().json;\n\n// In production:\n// 1. INSERT into pricing_history for each product\n// 2. UPDATE supplier_mapped_products set is_active = true\n// 3. Create snapshot in pricing_history with snapshot_date\n// 4. Notify affected restaurants (optional)\n\nconst version = 'v' + new Date().toISOString().split('T')[0].replace(/-/g, '');\nconst timestamp = new Date().toISOString();\n\nconst publishResult = {\n  success: true,\n  version: version,\n  published_at: timestamp,\n  products_updated: 22,\n  products_added: 3,\n  restaurants_notified: 0, // In production: query restaurants using these products\n  db_operations: [\n    'INSERT into pricing_history (22 rows)',\n    'UPDATE supplier_mapped_products (25 rows)',\n    'Snapshot created'\n  ],\n  changelog: [\n    {action: 'price_update', count: 18, table: 'pricing_history'},\n    {action: 'new_product', count: 3, table: 'supplier_mapped_products'},\n    {action: 'availability_change', count: 4, field: 'is_active'}\n  ],\n  message: 'ðŸ“¤ *LISTA PUBLICADA COM SUCESSO*\\n\\n' +\n    `âœ… VersÃ£o: *${version}*\\n` +\n    `ðŸ“… Data: ${new Date().toLocaleDateString('pt-BR')}\\n\\n` +\n    '*MudanÃ§as aplicadas:*\\n' +\n    'â€¢ 22 produtos atualizados\\n' +\n    'â€¢ 3 produtos novos adicionados\\n' +\n    'â€¢ HistÃ³rico registrado em pricing_history\\n\\n' +\n    'ðŸŽ‰ Seus produtos jÃ¡ estÃ£o disponÃ­veis!\\n' +\n    'Os restaurantes podem ver e fazer pedidos.\\n\\n' +\n    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\n' +\n    'Digite \"menu\" para mais opÃ§Ãµes.',\n  next_action: 'show_menu'\n};\n\nreturn JSON.stringify(publishResult);"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -912,
        1472
      ],
      "id": "tool-publish-catalog",
      "name": "publish_to_catalog"
    },
    {
      "parameters": {
        "description": "Mostra o menu principal de opÃ§Ãµes para fornecedores.",
        "jsCode": "// ===== SHOW SUPPLIER MENU =====\nconst menu = `ðŸª *MENU PRINCIPAL - FORNECEDOR*\\n\\n` +\n  `Que operaÃ§Ã£o quer realizar?\\n\\n` +\n  `1ï¸âƒ£ ðŸ’° *Enviar lista de preÃ§os*\\n` +\n  `   Atualizar produtos e preÃ§os\\n\\n` +\n  `2ï¸âƒ£ ðŸ“‹ *Ver catÃ¡logo ativo*\\n` +\n  `   Consultar produtos publicados\\n\\n` +\n  `3ï¸âƒ£ ðŸ“Š *HistÃ³rico de vendas*\\n` +\n  `   Ver pedidos recebidos\\n\\n` +\n  `4ï¸âƒ£ âš™ï¸ *Configurar perfil*\\n` +\n  `   Atualizar dados da empresa\\n\\n` +\n  `Digite o nÃºmero ou descreva o que precisa.`;\n\nreturn JSON.stringify({\n  menu: menu,\n  options: ['preÃ§os', 'catÃ¡logo', 'vendas', 'perfil']\n});"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -784,
        1472
      ],
      "id": "tool-supplier-menu",
      "name": "show_supplier_menu"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0.3,
          "timeout": 30000,
          "maxRetries": 3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -1424,
        1200
      ],
      "id": "openai-customer-001",
      "name": "OpenAI Chat Customer",
      "credentials": {
        "openAiApi": {
          "id": "MdAepMtuPO5nFVI0",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0.2,
          "timeout": 30000,
          "maxRetries": 3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -1424,
        1456
      ],
      "id": "openai-supplier-001",
      "name": "OpenAI Chat Supplier",
      "credentials": {
        "openAiApi": {
          "id": "MdAepMtuPO5nFVI0",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Extract Message Data').first().json.session_id }}",
        "contextWindowLength": 30
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -1296,
        1200
      ],
      "id": "memory-customer-001",
      "name": "Memory Customer"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Extract Message Data').first().json.session_id }}",
        "contextWindowLength": 30
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -1296,
        1456
      ],
      "id": "memory-supplier-001",
      "name": "Memory Supplier"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('WhatsApp Trigger').first().json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "={{ $('Extract Message Data').first().json.phone_number }}",
        "textBody": "={{ $json.output || $json.message || 'Oi! Algo deu errado. Tente novamente! ðŸ˜Š' }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        -640,
        1200
      ],
      "id": "respond-whatsapp-001",
      "name": "Send WhatsApp Response",
      "credentials": {
        "whatsAppApi": {
          "id": "Jb7XPGihYb3LXtzN",
          "name": "Frepi Account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "WhatsApp Trigger": {
      "main": [
        [
          {
            "node": "Extract Message Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Message Data": {
      "main": [
        [
          {
            "node": "Buscar Usuario en DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Usuario en DB": {
      "main": [
        [
          {
            "node": "Prepare User Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare User Context": {
      "main": [
        [
          {
            "node": "Route: Customer or Supplier?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route: Customer or Supplier?": {
      "main": [
        [
          {
            "node": "Supplier Journey Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Customer Journey Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Customer Journey Agent": {
      "main": [
        [
          {
            "node": "Send WhatsApp Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supplier Journey Agent": {
      "main": [
        [
          {
            "node": "Send WhatsApp Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "onboarding_restaurant": {
      "ai_tool": [
        [
          {
            "node": "Customer Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "setup_buying_preferences": {
      "ai_tool": [
        [
          {
            "node": "Customer Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "search_products_vector": {
      "ai_tool": [
        [
          {
            "node": "Customer Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "build_shopping_cart": {
      "ai_tool": [
        [
          {
            "node": "Customer Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "execute_checkout": {
      "ai_tool": [
        [
          {
            "node": "Customer Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "show_customer_menu": {
      "ai_tool": [
        [
          {
            "node": "Customer Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "onboarding_supplier": {
      "ai_tool": [
        [
          {
            "node": "Supplier Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "upload_supplier_prices": {
      "ai_tool": [
        [
          {
            "node": "Supplier Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "normalize_product_list": {
      "ai_tool": [
        [
          {
            "node": "Supplier Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "publish_to_catalog": {
      "ai_tool": [
        [
          {
            "node": "Supplier Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "show_supplier_menu": {
      "ai_tool": [
        [
          {
            "node": "Supplier Journey Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Customer": {
      "ai_languageModel": [
        [
          {
            "node": "Customer Journey Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Supplier": {
      "ai_languageModel": [
        [
          {
            "node": "Supplier Journey Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Memory Customer": {
      "ai_memory": [
        [
          {
            "node": "Customer Journey Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Memory Supplier": {
      "ai_memory": [
        [
          {
            "node": "Supplier Journey Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "frepi-mvp2-supabase-validated-v1",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "49b8809ac9c6d78ac189292d079f6fecdaf436806e595e6107033a10240b1fea"
  },
  "id": "FrepiMVP2Validated",
  "tags": [
    {
      "id": "frepi-v2-supabase-validations",
      "name": "frepi-v2-validated"
    }
  ]
}
